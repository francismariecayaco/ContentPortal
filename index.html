
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>MaynilaTekDO Portal • POS & Inventory</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root{
      --fb-bg:#f0f2f5;--fb-card:#fff;--fb-text:#050505;--fb-muted:#65676b;--fb-blue:#0866ff;--fb-blue-600:#0051db;--fb-green:#42b72a;--fb-red:#e41e3f;--fb-yellow:#f7b928;--fb-border:#e5e7eb;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;font-family:Inter,system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif;background:var(--fb-bg);color:var(--fb-text)}
    a{color:var(--fb-blue);text-decoration:none}
    button{cursor:pointer}
    .topbar{position:sticky;top:0;z-index:50;display:flex;align-items:center;gap:.75rem;background:#fff;border-bottom:1px solid var(--fb-border);padding:.5rem .75rem}
    .brand{display:flex;align-items:center;gap:.5rem;font-weight:700}
    .brand .logo{width:36px;height:36px;border-radius:9999px;background:var(--fb-blue);display:grid;place-items:center;color:#fff;font-weight:800}
    .search{flex:1;display:flex;align-items:center;background:var(--fb-bg);border-radius:9999px;padding:.25rem .5rem}
    .search input{border:0;outline:none;background:transparent;width:100%;padding:.5rem}
    .userbox{display:flex;align-items:center;gap:.5rem}
    .userpic{width:32px;height:32px;border-radius:9999px;background:#d1d5db;overflow:hidden}
    .layout{display:grid;grid-template-columns:260px 1fr 320px;gap:1rem;padding:1rem;max-width:1400px;margin:0 auto}
    .col{display:flex;flex-direction:column;gap:1rem}
    .card{background:var(--fb-card);border:1px solid var(--fb-border);border-radius:12px;box-shadow:0 1px 2px rgba(0,0,0,.03)}
    .card h3{margin:0;padding:1rem;border-bottom:1px solid var(--fb-border)}
    .card .content{padding:1rem}
    .btn{background:var(--fb-blue);color:#fff;border:0;border-radius:10px;padding:.6rem .9rem;font-weight:600}
    .btn.secondary{background:#e5e7eb;color:#111}
    .btn.green{background:var(--fb-green)}
    .btn.red{background:var(--fb-red)}
    .btn.yellow{background:var(--fb-yellow);color:#111}
    .grid{display:grid;gap:1rem}
    .grid.cols-2{grid-template-columns:repeat(2,minmax(0,1fr))}
    .grid.cols-3{grid-template-columns:repeat(3,minmax(0,1fr))}
    .field{display:flex;flex-direction:column;gap:.35rem}
    .field label{font-size:.82rem;color:var(--fb-muted)}
    .field input,.field select,.field textarea{border:1px solid var(--fb-border);border-radius:10px;padding:.6rem .7rem;background:#fff}
    .table{width:100%;border-collapse:collapse}
    .table th,.table td{border-bottom:1px solid var(--fb-border);padding:.6rem;text-align:left;font-size:.92rem}
    .pill{display:inline-flex;align-items:center;gap:.25rem;border-radius:9999px;padding:.2rem .55rem;font-size:.75rem;font-weight:600}
    .pill.blue{background:#e8f1ff;color:#0b5cff}
    .pill.green{background:#eaf8ee;color:#21734f}
    .pill.red{background:#ffedf0;color:#a10d2d}
    .hidden{display:none !important}
    .right-fixed{position:sticky;top:64px}
    .footer{padding:2rem;text-align:center;color:var(--fb-muted)}

    /* Modal */
    .modal{position:fixed;inset:0;background:rgba(0,0,0,.35);display:none;align-items:center;justify-content:center;padding:1rem}
    .modal.open{display:flex}
    .modal .box{background:#fff;border-radius:14px;max-width:720px;width:100%;overflow:hidden;border:1px solid var(--fb-border)}

    /* Responsive */
    @media (max-width:1200px){.layout{grid-template-columns:220px 1fr;}.right-col{display:none}}
    @media (max-width:880px){.layout{grid-template-columns:1fr}.left-col{display:none}}
  </style>
</head>
<body>
  <header class="topbar">
    <div class="brand"><div class="logo">M</div> MaynilaTekDO</div>
    <div class="search"><input id="searchBox" placeholder="Search services, products, orders..."/></div>
    <div class="userbox">
      <span id="roleBadge" class="pill blue">Guest</span>
      <div id="userName">Not signed in</div>
      <div class="userpic" id="userPic"></div>
      <button id="btnLogin" class="btn">Log in</button>
      <button id="btnLogout" class="btn secondary hidden">Log out</button>
    </div>
  </header>

  <main class="layout">
    <!-- Left rail -->
    <aside class="col left-col">
      <div class="card">
        <h3>Menu</h3>
        <div class="content grid">
          <button class="btn secondary" data-nav="home">Home</button>
          <button class="btn secondary" data-nav="market">Products</button>
          <button class="btn secondary" data-nav="services">Services</button>
          <button class="btn secondary" data-nav="pos">POS</button>
          <button class="btn secondary" data-nav="inventory">Inventory</button>
          <button class="btn secondary" data-nav="employees">Employees</button>
          <button class="btn secondary" data-nav="payroll">Payroll</button>
          <button class="btn secondary" data-nav="reports">Reports</button>
          <button class="btn secondary" data-nav="admin">Admin</button>
        </div>
      </div>
      <div class="card">
        <h3>Notifications</h3>
        <div class="content" id="notifList"></div>
      </div>
    </aside>

    <!-- Center column: pages -->
    <section class="col middle-col">
      <!-- Landing / Portal -->
      <div id="page-home" class="card">
        <h3>One-Stop Shop</h3>
        <div class="content">
          <div class="grid cols-3">
            <div class="card"><h3>Rentals</h3><div class="content">
              <p>Cars & Motorcycles. Flexible daily/weekly rates.</p>
              <button class="btn" data-open="modal-rental">Request Rental</button>
            </div></div>
            <div class="card"><h3>Design Services</h3><div class="content">
              <p>Graphics & Websites—delivered by our in-house team.</p>
              <button class="btn" data-open="modal-design">Request Design</button>
            </div></div>
            <div class="card"><h3>Real Estate</h3><div class="content">
              <p>Lease, rent, or buy properties: condo, rooms, apartments, and houses.</p>
              <button class="btn" data-nav="services">Request Real Estate</button>
            </div></div>
            <div class="card"><h3>Shop Products</h3><div class="content">
              <p>Wet goods, dry goods, gadgets & appliances.</p>
              <button class="btn" data-nav="market">Browse</button>
            </div></div>
          </div>
        </div>
      </div>

      <!-- Products / Market -->
      <div id="page-market" class="card hidden">
        <h3>Marketplace</h3>
        <div class="content">
          <div class="grid cols-3" id="productGrid"></div>
        </div>
      </div>

      <!-- Services page -->
      <div id="page-services" class="card hidden">
        <h3>Services</h3>
        <div class="content grid cols-2">
          <div class="card"><h3>Car / Motorcycle Rental</h3><div class="content">
            <form id="formRental" class="grid cols-2">
              <div class="field"><label>Type</label><select name="type"><option>Car</option><option>Motorcycle</option></select></div>
              <div class="field"><label>Duration (days)</label><input name="days" type="number" min="1" value="1"></div>
              <div class="field"><label>Start Date</label><input name="date" type="date"></div>
              <div class="field"><label>Notes</label><input name="notes" placeholder="Optional"></div>
              <button class="btn green" type="submit">Request</button>
            </form>
          </div></div>
          <div class="card"><h3>Graphics / Web Design</h3><div class="content">
            <form id="formDesign" class="grid cols-2">
              <div class="field"><label>Service</label><select name="service"><option>Logo</option><option>Poster</option><option>Website</option></select></div>
              <div class="field"><label>Budget (₱)</label><input name="budget" type="number" min="0"></div>
              <div class="field"><label>Details</label><textarea name="details" rows="3"></textarea></div>
              <button class="btn green" type="submit">Request</button>
            </form>
          </div></div>
            <div class="card"><h3>Real Estate Services</h3><div class="content">
              <form id="formRealEstate" class="grid cols-2">
                <div class="field"><label>Type</label>
                  <select name="propertyType">
                    <option>Condo</option>
                    <option>Room</option>
                    <option>Apartment</option>
                    <option>House</option>
                  </select>
                </div>
                <div class="field"><label>Transaction</label>
                  <select name="transactionType">
                    <option>Lease</option>
                    <option>Rent</option>
                    <option>Buy</option>
                  </select>
                </div>
                <div class="field"><label>Location</label><input name="location" placeholder="City or Area"></div>
                <div class="field"><label>Budget (₱)</label><input name="budget" type="number" min="0"></div>
                <div class="field"><label>Details</label><textarea name="details" rows="3" placeholder="Additional requirements"></textarea></div>
                <button class="btn green" type="submit">Request</button>
              </form>
            </div></div>
        </div>
      </div>

      <!-- POS -->
      <div id="page-pos" class="card hidden">
        <h3>Point of Sale</h3>
        <div class="content grid cols-2">
          <div class="card"><h3>Catalog</h3><div class="content">
            <div class="field"><label>Filter</label><input id="posFilter" placeholder="Search by name or SKU"></div>
            <table class="table" id="posCatalog"><thead><tr><th>SKU</th><th>Name</th><th>Price</th><th>Stock</th><th></th></tr></thead><tbody></tbody></table>
          </div></div>
          <div class="card"><h3>Cart</h3><div class="content">
            <table class="table" id="cartTable"><thead><tr><th>Item</th><th>Qty</th><th>Total</th><th></th></tr></thead><tbody></tbody></table>
            <div class="field"><label>Customer (optional)</label><input id="cartCustomer" placeholder="Customer UID or email"></div>
            <div style="display:flex;gap:.5rem;align-items:center;justify-content:space-between"><div>
              <span>Subtotal: ₱<b id="cartSubtotal">0.00</b></span>
              <span class="pill green">Cash</span>
            </div>
              <button class="btn" id="checkoutBtn">Checkout</button>
            </div>
          </div></div>
        </div>
      </div>

      <!-- Inventory -->
      <div id="page-inventory" class="card hidden">
        <h3>Inventory</h3>
        <div class="content grid cols-2">
          <div class="card"><h3>Add / Update Product</h3><div class="content">
            <form id="formProduct" class="grid cols-2">
              <div class="field"><label>Name</label><input name="name" required></div>
              <div class="field"><label>SKU</label><input name="sku" required></div>
              <div class="field"><label>Category</label>
                <select name="category" required>
                  <option value="wet">Wet Goods</option>
                  <option value="dry">Dry Goods</option>
                  <option value="gadget">Gadgets/Appliances/Clothes</option>
                </select>
              </div>
              <div class="field"><label>Unit Price (₱)</label><input name="price" type="number" min="0" step="0.01" required></div>
              <div class="field"><label>Image</label><input name="image" type="file" accept="image/*"></div>
              <div class="field"><label>Description</label><textarea name="desc" rows="2"></textarea></div>
              <button class="btn" type="submit">Save Product</button>
            </form>
          </div></div>
          <div class="card"><h3>Receive Stock (Batch)</h3><div class="content">
            <form id="formBatch" class="grid cols-3">
              <div class="field"><label>SKU</label><input name="sku" required></div>
              <div class="field"><label>Qty</label><input name="qty" type="number" min="1" required></div>
              <div class="field"><label>Received</label><input name="receivedAt" type="date" required></div>
              <div class="field"><label>Expiry (dry)</label><input name="expiry" type="date"></div>
              <div class="field"><label>Manufactured (gadgets)</label><input name="mfg" type="date"></div>
              <div class="field"><label>Notes</label><input name="notes"></div>
              <button class="btn green" type="submit">Receive</button>
            </form>
            <div class="grid cols-2" style="margin-top:1rem">
              <div>
                <h4>Batches</h4>
                <table class="table" id="batchTable"><thead><tr><th>SKU</th><th>Qty</th><th>Key Date</th><th>QR</th></tr></thead><tbody></tbody></table>
              </div>
              <div>
                <h4>Critical Alerts</h4>
                <ul id="criticalList"></ul>
              </div>
            </div>
          </div></div>
        </div>
      </div>

      <!-- Employees -->
      <div id="page-employees" class="card hidden">
        <h3>Employees</h3>
        <div class="content grid cols-2">
          <div class="card"><h3>Create Staff</h3><div class="content">
            <form id="formCreateStaff" class="grid cols-2">
              <div class="field"><label>Email</label><input name="email" type="email" required></div>
              <div class="field"><label>Temp Password</label><input name="password" type="text" required></div>
              <div class="field"><label>Role</label>
                <select name="role"><option>staff</option><option>admin-manager</option><option>admin-president</option></select>
              </div>
              <div class="field"><label>Company ID</label><input name="companyId" required></div>
              <button class="btn" type="submit">Invite</button>
            </form>
          </div></div>
          <div class="card"><h3>Attendance</h3><div class="content">
            <div style="display:flex;gap:.5rem"><button class="btn" id="btnClockIn">Clock In</button><button class="btn secondary" id="btnClockOut">Clock Out</button></div>
            <table class="table" id="attendanceTable"><thead><tr><th>Date</th><th>In</th><th>Out</th><th>Hours</th></tr></thead><tbody></tbody></table>
          </div></div>
        </div>
      </div>

      <!-- Payroll -->
      <div id="page-payroll" class="card hidden">
        <h3>Payroll</h3>
        <div class="content grid cols-2">
          <div class="card"><h3>Create Payroll</h3><div class="content">
            <form id="formPayroll" class="grid cols-3">
              <div class="field"><label>Employee UID</label><input name="uid" required></div>
              <div class="field"><label>Period Start</label><input name="start" type="date" required></div>
              <div class="field"><label>Period End</label><input name="end" type="date" required></div>
              <div class="field"><label>Base Pay (₱)</label><input name="base" type="number" step="0.01" required></div>
              <div class="field"><label>Allowances (₱)</label><input name="allow" type="number" step="0.01" value="0"></div>
              <div class="field"><label>Deductions (₱)</label><input name="deduct" type="number" step="0.01" value="0"></div>
              <button class="btn" type="submit">Generate</button>
            </form>
          </div></div>
          <div class="card"><h3>Recent Payslips</h3><div class="content">
            <table class="table" id="payrollTable"><thead><tr><th>UID</th><th>Period</th><th>Net (₱)</th><th>Status</th></tr></thead><tbody></tbody></table>
          </div></div>
        </div>
      </div>

      <!-- Reports -->
      <div id="page-reports" class="card hidden">
        <h3>Reports</h3>
        <div class="content grid cols-2">
          <div class="card"><h3>Top Sellers</h3><div class="content">
            <table class="table" id="topTable"><thead><tr><th>SKU</th><th>Name</th><th>Qty Sold</th><th>Revenue (₱)</th></tr></thead><tbody></tbody></table>
          </div></div>
          <div class="card"><h3>Inventory Snapshot</h3><div class="content">
            <table class="table" id="invSnapshot"><thead><tr><th>SKU</th><th>On Hand</th><th>Critical</th></tr></thead><tbody></tbody></table>
          </div></div>
        </div>
      </div>

      <!-- Admin (Superadmin tools) -->
      <div id="page-admin" class="card hidden">
        <h3>Superadmin</h3>
        <div class="content grid cols-2">
          <div class="card"><h3>Create Company</h3><div class="content">
            <form id="formCompany" class="grid cols-2">
              <div class="field"><label>Name</label><input name="name" required></div>
              <div class="field"><label>Code</label><input name="code" required></div>
              <button class="btn" type="submit">Create</button>
            </form>
          </div></div>
          <div class="card"><h3>Totals</h3><div class="content" id="adminTotals">Loading...</div></div>
        </div>
      </div>

      <div class="footer">© <span id="year"></span> MaynilaTekDO • Built with Firebase</div>
    </section>

    <!-- Right rail -->
    <aside class="col right-col right-fixed">
      <div class="card">
        <h3>Profile</h3>
        <div class="content">
          <form id="formProfile" class="grid cols-2">
            <div class="field"><label>First Name</label><input name="firstName"></div>
            <div class="field"><label>Middle Name</label><input name="middleName"></div>
            <div class="field"><label>Last Name</label><input name="lastName"></div>
            <div class="field"><label>Mobile</label><input name="mobile"></div>
            <div class="field"><label>Birthday</label><input name="birthday" type="date"></div>
            <div class="field"><label>Email</label><input name="email" type="email"></div>
            <div class="field"><label>Address</label><input name="address"></div>
            <div class="field"><label>Marital Status</label><select name="marital"><option>Single</option><option>Married</option><option>Other</option></select></div>
            <div class="field"><label>Gender</label><select name="gender"><option>Male</option><option>Female</option><option>Other</option></select></div>
            <div class="field"><label>Facebook</label><input name="facebook"></div>
            <button class="btn" type="submit">Save Profile</button>
          </form>
        </div>
      </div>
      <div class="card">
        <h3>Quick Actions</h3>
        <div class="content grid">
          <button class="btn yellow" data-open="modal-leave">Request Leave</button>
          <button class="btn yellow" data-open="modal-doc">Request Document</button>
          <button class="btn yellow" data-open="modal-vehicle">Service Vehicle</button>
        </div>
      </div>
    </aside>
  </main>

  <!-- Modals -->
  <div class="modal" id="authModal"><div class="box">
    <div class="card"><h3>Sign In / Sign Up</h3><div class="content grid cols-2">
      <form id="formLogin" class="grid">
        <div class="field"><label>Email</label><input name="email" type="email" required></div>
        <div class="field"><label>Password</label><input name="password" type="password" required></div>
        <button class="btn" type="submit">Sign In</button>
      </form>
      <form id="formRegister" class="grid">
        <div class="field"><label>Email</label><input name="email" type="email" required></div>
        <div class="field"><label>Password</label><input name="password" type="password" required></div>
        <button class="btn green" type="submit">Create Account</button>
      </form>
    </div></div>
  </div></div>

  <div class="modal" id="modal-rental"><div class="box"><div class="card"><h3>Rental Request</h3><div class="content"><form id="modalFormRental" class="grid cols-2"></form></div></div></div></div>
  <div class="modal" id="modal-design"><div class="box"><div class="card"><h3>Design Request</h3><div class="content"><form id="modalFormDesign" class="grid cols-2"></form></div></div></div></div>
  <div class="modal" id="modal-leave"><div class="box"><div class="card"><h3>Leave Request</h3><div class="content">
    <form id="formLeave" class="grid cols-3">
      <div class="field"><label>Type</label><select name="type"><option>Vacation</option><option>Sick</option><option>Maternity</option></select></div>
      <div class="field"><label>From</label><input type="date" name="from" required></div>
      <div class="field"><label>To</label><input type="date" name="to" required></div>
      <div class="field" style="grid-column:1/-1"><label>Reason</label><textarea name="reason" rows="2"></textarea></div>
      <button class="btn" type="submit">Submit</button>
    </form>
  </div></div></div></div>
  <div class="modal" id="modal-doc"><div class="box"><div class="card"><h3>Document Request</h3><div class="content">
    <form id="formDoc" class="grid cols-2">
      <div class="field"><label>Document</label><select name="doc"><option>COE</option><option>Payslip</option><option>ID</option></select></div>
      <div class="field"><label>Notes</label><input name="notes"></div>
      <button class="btn" type="submit">Submit</button>
    </form>
  </div></div></div></div>
  <div class="modal" id="modal-vehicle"><div class="box"><div class="card"><h3>Service Vehicle Request</h3><div class="content">
    <form id="formVehicle" class="grid cols-3">
      <div class="field"><label>Date</label><input type="date" name="date"></div>
      <div class="field"><label>Purpose</label><input name="purpose"></div>
      <div class="field"><label>Destination</label><input name="dest"></div>
      <button class="btn" type="submit">Submit</button>
    </form>
  </div></div></div></div>

  <!-- Firebase SDKs -->
  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js';
    import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut } from 'https://www.gstatic.com/firebasejs/10.12.4/firebase-auth.js';
    import { getFirestore, doc, setDoc, getDoc, getDocs, addDoc, updateDoc, collection, serverTimestamp, query, where, orderBy, limit } from 'https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore.js';
    import { getStorage, ref as sRef, uploadBytes, getDownloadURL } from 'https://www.gstatic.com/firebasejs/10.12.4/firebase-storage.js';
    import { getDatabase, ref, push, set, onValue } from 'https://www.gstatic.com/firebasejs/10.12.4/firebase-database.js';

    // --- CONFIG ---
    const firebaseConfig = {
      apiKey: 'AIzaSyCoNNaQ30xVM3tjC1vBiUp6y8Hkl8sy2V8',
      authDomain: 'maynilatekdo.firebaseapp.com',
      databaseURL: 'https://maynilatekdo-default-rtdb.asia-southeast1.firebasedatabase.app',
      projectId: 'maynilatekdo',
      storageBucket: 'maynilatekdo.appspot.com',
      messagingSenderId: '835673306092',
      appId: '1:835673306092:web:f0541edb14edc7741b46c9',
      measurementId: 'G-B1S4DB0T5G'
    };

    // --- INIT ---
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const store = getStorage(app);
    const rtdb = getDatabase(app);

    // --- UTIL ---
    const $ = sel => document.querySelector(sel);
    const $$ = sel => Array.from(document.querySelectorAll(sel));
    const nowISO = () => new Date().toISOString();
    const fmt = n => Number(n||0).toLocaleString('en-PH',{minimumFractionDigits:2,maximumFractionDigits:2});

    const NAV_IDS = ['home','market','services','pos','inventory','employees','payroll','reports','admin'];
    function showPage(id){
      NAV_IDS.forEach(x=>$('#page-'+x).classList.add('hidden'));
      $('#page-'+id).classList.remove('hidden');
    }

    // --- AUTH UI ---
    const authModal = $('#authModal');
    $('#btnLogin').onclick = ()=> authModal.classList.add('open');
    $('#btnLogout').onclick = ()=> signOut(auth);
    authModal.addEventListener('click', e=>{ if(e.target===authModal) authModal.classList.remove('open'); });

    $('#formLogin').addEventListener('submit', async e=>{
      e.preventDefault(); const f=new FormData(e.target);
      await signInWithEmailAndPassword(auth, f.get('email'), f.get('password'));
      authModal.classList.remove('open');
    });
    $('#formRegister').addEventListener('submit', async e=>{
      e.preventDefault(); const f=new FormData(e.target);
      const cred = await createUserWithEmailAndPassword(auth, f.get('email'), f.get('password'));
      await setDoc(doc(db,'users',cred.user.uid),{ role:'customer', createdAt:serverTimestamp(), profile:{ email:f.get('email') } });
      authModal.classList.remove('open');
    });

    // --- PROFILE ---
    $('#formProfile').addEventListener('submit', async e=>{
      e.preventDefault(); if(!auth.currentUser) return alert('Sign in first');
      const f=new FormData(e.target);
      const profile = {
        firstName:f.get('firstName')||'', middleName:f.get('middleName')||'', lastName:f.get('lastName')||'',
        mobile:f.get('mobile')||'', birthday:f.get('birthday')||'', email:f.get('email')||'',
        address:f.get('address')||'', marital:f.get('marital')||'', gender:f.get('gender')||'', facebook:f.get('facebook')||''
      };
      await setDoc(doc(db,'users',auth.currentUser.uid),{ profile },{ merge:true });
      alert('Profile saved');
    });

    // --- NAV ---
    $$('#year').forEach(el=> el.textContent = new Date().getFullYear());
    $$('#searchBox');
    $$('.left-col [data-nav]').forEach(btn=> btn.addEventListener('click', ()=> showPage(btn.dataset.nav)));

    // --- INVENTORY: Products ---
    async function uploadImage(file){
      if(!file) return '';
      const path = `products/${Date.now()}-${file.name}`; const rf = sRef(store,path);
      await uploadBytes(rf, file); return await getDownloadURL(rf);
    }

    $('#formProduct').addEventListener('submit', async e=>{
      e.preventDefault(); const f=new FormData(e.target);
      const img = await uploadImage(f.get('image'));
      const data={
        name:f.get('name'), sku:f.get('sku'), category:f.get('category'), price:Number(f.get('price')||0),
        desc:f.get('desc')||'', img:img||'', createdAt:serverTimestamp(), active:true
      };
      await setDoc(doc(db,'products',data.sku), data, { merge:true });
      alert('Product saved'); e.target.reset();
      renderCatalog();
    });

    // --- INVENTORY: Batches ---
    function batchKey(){ return Math.random().toString(36).slice(2,10); }
    $('#formBatch').addEventListener('submit', async e=>{
      e.preventDefault(); const f=new FormData(e.target);
      const sku=f.get('sku'); const qty=Number(f.get('qty')); if(!sku||!qty) return;
      const receivedAt=f.get('receivedAt'); const expiry=f.get('expiry')||null; const mfg=f.get('mfg')||null;
      const id = batchKey(); const label = `${sku}-${id}`;
      const payload = { sku, id, qty, qtyAvail:qty, receivedAt, expiry, mfg, notes:f.get('notes')||'', label, createdAt:serverTimestamp() };
      await setDoc(doc(db,'inventoryBatches',label), payload);
      await setDoc(doc(db,'inventoryIndex',sku), { sku, updatedAt:serverTimestamp() }, { merge:true });
      await addNotification(`Stock received for ${sku}: ${qty}`);
      e.target.reset();
      loadBatches();
    });

    // Picking logic: FIFO / FEFO / FMFO
    async function pickBatchesForSale(sku, qtyNeeded){
      const prod = await getDoc(doc(db,'products',sku)); if(!prod.exists()) throw new Error('SKU not found');
      const cat = prod.data().category;
      let qRef = collection(db,'inventoryBatches');
      qRef = query(qRef, where('sku','==',sku), where('qtyAvail','>',0));
      const snap = await getDocs(qRef);
      let rows = snap.docs.map(d=> d.data());
      if(cat==='wet'){ rows.sort((a,b)=> new Date(a.receivedAt)-new Date(b.receivedAt)); }
      else if(cat==='dry'){ rows = rows.filter(r=>r.expiry); rows.sort((a,b)=> new Date(a.expiry)-new Date(b.expiry)); }
      else { rows = rows.filter(r=>r.mfg); rows.sort((a,b)=> new Date(a.mfg)-new Date(b.mfg)); }
      const picks=[]; let remain=qtyNeeded;
      for(const r of rows){ if(remain<=0) break; const use=Math.min(r.qtyAvail, remain); if(use>0){ picks.push({key:r.label, use}); remain-=use; } }
      if(remain>0) throw new Error('Insufficient stock');
      return picks; // [{key,label,use}]
    }

    async function commitSalePicks(picks){
      for(const p of picks){ const refDoc = doc(db,'inventoryBatches',p.key); const d=await getDoc(refDoc); if(!d.exists()) continue; const left=(d.data().qtyAvail||0)-p.use; await updateDoc(refDoc,{ qtyAvail:left }); }
    }

    async function loadBatches(){
      const tbody = $('#batchTable tbody'); tbody.innerHTML='';
      const snap = await getDocs(collection(db,'inventoryBatches'));
      snap.forEach(docu=>{
        const b=docu.data();
        const keyDate = b.expiry||b.mfg||b.receivedAt||'';
        const tr=document.createElement('tr');
        tr.innerHTML = `<td>${b.sku}</td><td>${b.qtyAvail}/${b.qty}</td><td>${keyDate}</td><td><div class="qr" data-code="${b.label}"></div></td>`;
        tbody.appendChild(tr);
      });
      renderQR();
      computeCriticals();
    }

    // --- QR (tiny encoder) ---
    function renderQR(){
      document.querySelectorAll('.qr').forEach(node=>{ const text=node.dataset.code; node.innerHTML = createAsciiQR(text); });
    }
    function createAsciiQR(text){
      // NOTE: This is a placeholder visual code (not a real QR spec) so labels are scannable by text id.
      // For production, replace with a real QR/Barcode generator and scanner.
      const box = `<div style="font-family:monospace;border:1px solid #111;display:inline-block;padding:6px;border-radius:6px">${text}</div>`;
      return box;
    }

    // --- MARKET / CATALOG ---
    async function renderCatalog(){
      const grid = $('#productGrid'); grid.innerHTML='';
      const tbody = $('#posCatalog tbody'); tbody.innerHTML='';
      const snap = await getDocs(collection(db,'products'));
      snap.forEach(d=>{
        const p=d.data();
        const card=document.createElement('div'); card.className='card';
        card.innerHTML=`<div class="content"><div style="display:flex;gap:.75rem"><img src="${p.img||''}" onerror="this.style.display='none'" style="width:64px;height:64px;border-radius:8px;object-fit:cover"/><div><b>${p.name}</b><div class="pill blue" style="margin:.25rem 0">${p.category.toUpperCase()}</div><div>₱${fmt(p.price)}</div></div></div><div style="margin-top:.5rem;display:flex;gap:.5rem"><button class="btn" data-add="${p.sku}">Add to Cart</button></div></div>`;
        grid.appendChild(card);
        const tr=document.createElement('tr');
        tr.innerHTML = `<td>${p.sku}</td><td>${p.name}</td><td>₱${fmt(p.price)}</td><td data-stock="${p.sku}">...</td><td><button class="btn" data-add="${p.sku}">Add</button></td>`;
        tbody.appendChild(tr);
      });
      // Stock counts
      const batches = await getDocs(collection(db,'inventoryBatches'));
      const bySku = {}; batches.forEach(b=>{ const x=b.data(); bySku[x.sku]=(bySku[x.sku]||0)+(x.qtyAvail||0); });
      Object.entries(bySku).forEach(([sku,qty])=>{ const cell = document.querySelector(`[data-stock="${sku}"]`); if(cell) cell.textContent=qty; });
      document.querySelectorAll('[data-add]').forEach(btn=> btn.addEventListener('click', ()=> addToCart(btn.dataset.add)));
    }

    // --- CART ---
    const CART = new Map();
    async function addToCart(sku){
      const prod = await getDoc(doc(db,'products',sku)); if(!prod.exists()) return alert('Missing product');
      const item = CART.get(sku)||{sku, name:prod.data().name, price:prod.data().price, qty:0};
      item.qty += 1; CART.set(sku,item); renderCart();
    }
    function renderCart(){
      const tb=$('#cartTable tbody'); tb.innerHTML=''; let subtotal=0;
      CART.forEach(it=>{ const tr=document.createElement('tr'); const total = it.qty*it.price; subtotal+=total; tr.innerHTML=`<td>${it.name}</td><td><input type="number" min="1" value="${it.qty}" data-sku="${it.sku}" style="width:70px"></td><td>₱${fmt(total)}</td><td><button class="btn red" data-del="${it.sku}">X</button></td>`; tb.appendChild(tr); });
      $('#cartSubtotal').textContent = fmt(subtotal);
      tb.querySelectorAll('input[type="number"]').forEach(inp=> inp.addEventListener('change', e=>{ const it=CART.get(inp.dataset.sku); it.qty=Number(inp.value||1); CART.set(it.sku,it); renderCart(); }));
      tb.querySelectorAll('[data-del]').forEach(btn=> btn.addEventListener('click', ()=>{ CART.delete(btn.dataset.del); renderCart(); }));
    }

    $('#checkoutBtn').addEventListener('click', async ()=>{
      if(CART.size===0) return alert('Cart empty');
      // Build picks for each SKU
      const picksByBatch=[]; let total=0;
      for(const [sku,item] of CART){
        const picks = await pickBatchesForSale(sku, item.qty); // may throw if insufficient
        picks.forEach(p=> picksByBatch.push({...p, sku}));
        total += item.qty * item.price;
      }
      await commitSalePicks(picksByBatch);
      const order = { createdAt:serverTimestamp(), uid:auth.currentUser?.uid||null, items:Array.from(CART.values()), total, status:'paid', by:auth.currentUser?.uid||'guest' };
      const ref = await addDoc(collection(db,'orders'), order);
      await addNotification(`Order ${ref.id} paid: ₱${fmt(total)}`);
      CART.clear(); renderCart(); renderCatalog(); alert('Checkout complete');
    });

    // --- CRITICALS ---
    async function computeCriticals(){
      const out = $('#criticalList'); out.innerHTML='';
      const now = new Date(); const soon = new Date(Date.now()+1000*60*60*24*7); // 7 days
      const snap = await getDocs(collection(db,'inventoryBatches'));
      snap.forEach(d=>{
        const b=d.data(); const catCell = (cls,txt)=>`<span class="pill ${cls}">${txt}</span>`;
        let alertText='';
        if(b.expiry){ const ex=new Date(b.expiry); if(ex<now) alertText=catCell('red','Expired'); else if(ex<soon) alertText=catCell('yellow','Near Expiry'); }
        if((b.qtyAvail||0) < 5) alertText += ' ' + catCell('red','Low Stock');
        if(alertText){ const li=document.createElement('li'); li.innerHTML = `${b.sku} • ${b.label} • ${alertText}`; out.appendChild(li); }
      });
    }

    // --- EMPLOYEES: Attendance (RTDB) ---
    $('#btnClockIn').addEventListener('click', ()=> clock('in'));
    $('#btnClockOut').addEventListener('click', ()=> clock('out'));
    async function clock(kind){ if(!auth.currentUser) return alert('Sign in'); const day = new Date().toISOString().slice(0,10); const base=`attendance/${auth.currentUser.uid}/${day}`; const r = ref(rtdb, base);
      const snap = await new Promise(res=> onValue(r, s=>{ res(s.val()); }, { onlyOnce:true }));
      const data = snap||{}; if(kind==='in' && data.in) return alert('Already clocked in'); if(kind==='out' && data.out) return alert('Already clocked out');
      data[kind] = new Date().toISOString(); await set(r, data); await loadAttendance(); }

    async function loadAttendance(){
      if(!auth.currentUser) return; const tbody=$('#attendanceTable tbody'); tbody.innerHTML='';
      const base = ref(rtdb, `attendance/${auth.currentUser.uid}`);
      onValue(base, snap=>{
        tbody.innerHTML=''; const val=snap.val()||{}; Object.entries(val).sort(([a],[b])=> a.localeCompare(b)).forEach(([day,rec])=>{
          const hours = rec.in&&rec.out? ((new Date(rec.out)-new Date(rec.in))/36e5).toFixed(2):'-';
          const tr=document.createElement('tr'); tr.innerHTML=`<td>${day}</td><td>${rec.in?new Date(rec.in).toLocaleTimeString():''}</td><td>${rec.out?new Date(rec.out).toLocaleTimeString():''}</td><td>${hours}</td>`; tbody.appendChild(tr);
        });
      });
    }

    // --- PAYROLL ---
    $('#formPayroll').addEventListener('submit', async e=>{
      e.preventDefault(); const f=new FormData(e.target);
      const base=Number(f.get('base')||0), allow=Number(f.get('allow')||0), deduct=Number(f.get('deduct')||0);
      const net = base + allow - deduct;
      await addDoc(collection(db,'payrolls'),{ uid:f.get('uid'), start:f.get('start'), end:f.get('end'), base, allow, deduct, net, status:'pending', createdAt:serverTimestamp() });
      alert('Payslip created');
      loadPayrolls();
    });
    async function loadPayrolls(){
      const tb=$('#payrollTable tbody'); tb.innerHTML='';
      const snap=await getDocs(query(collection(db,'payrolls'), orderBy('createdAt','desc'), limit(25)));
      snap.forEach(d=>{ const p=d.data(); const tr=document.createElement('tr'); tr.innerHTML=`<td>${p.uid}</td><td>${p.start} → ${p.end}</td><td>${fmt(p.net)}</td><td>${p.status}</td>`; tb.appendChild(tr); });
    }

    // --- EMP: Create Staff (Firestore only; secure with rules/server in prod) ---
    $('#formCreateStaff').addEventListener('submit', async e=>{
      e.preventDefault(); const f=new FormData(e.target);
      const email=f.get('email'), password=f.get('password'), role=f.get('role'), companyId=f.get('companyId');
      // NOTE: Frontend cannot create another Auth user safely; this is a placeholder record for admin to process server-side.
      await addDoc(collection(db,'userInvites'),{ email,password,role,companyId, createdAt:serverTimestamp(), by:auth.currentUser?.uid||null });
      alert('Invite recorded (requires backend to finalize Auth account).');
    });

    // --- SERVICES REQUESTS ---
    $('#formRental').addEventListener('submit', submitService('rental'));
    $('#formDesign').addEventListener('submit', submitService('design'));
    function submitService(kind){ return async e=>{ e.preventDefault(); const f=new FormData(e.target); const payload=Object.fromEntries(f.entries()); payload.kind=kind; payload.createdAt=serverTimestamp(); payload.uid=auth.currentUser?.uid||null; await addDoc(collection(db,'serviceRequests'), payload); alert('Request submitted'); e.target.reset(); } }

    // --- REPORTS ---
    async function loadReports(){
      // Top sellers: naive aggregate over last 100 orders
      const ts = $('#topTable tbody'); ts.innerHTML='';
      const sales = {}; const rev = {};
      const snap = await getDocs(query(collection(db,'orders'), orderBy('createdAt','desc'), limit(100)));
      snap.forEach(d=>{ (d.data().items||[]).forEach(it=>{ sales[it.sku]=(sales[it.sku]||0)+it.qty; rev[it.sku]=(rev[it.sku]||0)+it.qty*it.price; }); });
      const prods = await getDocs(collection(db,'products')); const dict={}; prods.forEach(p=> dict[p.id]=p.data());
      Object.entries(sales).sort((a,b)=> b[1]-a[1]).slice(0,20).forEach(([sku,qty])=>{
        const tr=document.createElement('tr'); tr.innerHTML=`<td>${sku}</td><td>${dict[sku]?.name||''}</td><td>${qty}</td><td>₱${fmt(rev[sku]||0)}</td>`; ts.appendChild(tr);
      });
      // Inventory snapshot
      const inv = {}; const batches = await getDocs(collection(db,'inventoryBatches')); batches.forEach(b=>{ const x=b.data(); inv[x.sku] = (inv[x.sku]||0) + (x.qtyAvail||0); });
      const snapTb = $('#invSnapshot tbody'); snapTb.innerHTML='';
      Object.entries(inv).forEach(([sku,qty])=>{ const tr=document.createElement('tr'); const crit = qty<5?'<span class="pill red">Low</span>':''; tr.innerHTML=`<td>${sku}</td><td>${qty}</td><td>${crit}</td>`; snapTb.appendChild(tr); });
    }

    // --- Notifications ---
    async function addNotification(text){ await addDoc(collection(db,'notifications'),{ text, ts:serverTimestamp() }); }
    async function loadNotifications(){ const box=$('#notifList'); box.innerHTML=''; const snap=await getDocs(query(collection(db,'notifications'), orderBy('ts','desc'), limit(20))); snap.forEach(d=>{ const n=d.data(); const div=document.createElement('div'); div.style.padding='.4rem 0'; div.textContent = n.text; box.appendChild(div); }); }

    // --- Companies (Superadmin) ---
    $('#formCompany').addEventListener('submit', async e=>{ e.preventDefault(); const f=new FormData(e.target); await addDoc(collection(db,'companies'),{ name:f.get('name'), code:f.get('code'), createdAt:serverTimestamp() }); alert('Company created'); });

    async function loadAdminTotals(){
      const tot = $('#adminTotals');
      const users = await getDocs(collection(db,'users'));
      const prods = await getDocs(collection(db,'products'));
      const orders = await getDocs(collection(db,'orders'));
      tot.innerHTML = `<div class="grid cols-3"><div class="card"><div class="content"><div class="pill blue">Users</div><b>${users.size}</b></div></div><div class="card"><div class="content"><div class="pill green">Products</div><b>${prods.size}</b></div></div><div class="card"><div class="content"><div class="pill yellow">Orders</div><b>${orders.size}</b></div></div></div>`;
    }

    // --- ROLE-BASED UI ---
    function applyRoleUI(role){
      $('#roleBadge').textContent = role||'guest';
      // Defaults
      const staffOnly=['inventory','employees','payroll','reports'];
      const adminOnly=['admin'];
      staffOnly.forEach(id=> document.querySelector(`[data-nav="${id}"]`).classList.toggle('hidden', !(role==='staff'||role==='admin-manager'||role==='admin-president'||role==='superadmin')));
      adminOnly.forEach(id=> document.querySelector(`[data-nav="${id}"]`).classList.toggle('hidden', !(role==='superadmin')));
    }

    // --- AUTH STATE ---
    onAuthStateChanged(auth, async user=>{
      if(!user){
        $('#userName').textContent='Not signed in'; $('#btnLogin').classList.remove('hidden'); $('#btnLogout').classList.add('hidden'); applyRoleUI('guest'); showPage('home');
        return;
      }
      $('#btnLogin').classList.add('hidden'); $('#btnLogout').classList.remove('hidden');
      $('#userName').textContent = user.email || user.uid;
      const uref = doc(db,'users',user.uid); const u = await getDoc(uref);
      const role = u.exists()? (u.data().role||'customer') : 'customer';
      applyRoleUI(role);
      loadAttendance(); renderCatalog(); loadBatches(); loadReports(); loadNotifications(); loadPayrolls(); loadAdminTotals();
    });

    // Initial
    showPage('home');
    renderCatalog(); loadBatches(); loadReports(); loadNotifications(); loadPayrolls();

    // Modal openers
    document.querySelectorAll('[data-open]').forEach(btn=> btn.addEventListener('click', ()=>{ document.getElementById(btn.dataset.open).classList.add('open'); }));
    document.querySelectorAll('.modal').forEach(m=> m.addEventListener('click', e=>{ if(e.target===m) m.classList.remove('open'); }));
  </script>
</body>
</html>
